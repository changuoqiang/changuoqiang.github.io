<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"openwares.net","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}};
  </script>
<meta name="description" content="CPL vs. DPL vs. RPLTo make this simpler, let’s first just consider CPL and DPL:    The CPL is your current privilege level.   The DPL is the privilege level of a segment. It defines the minimum1 priv">
<meta property="og:type" content="article">
<meta property="og:title" content="CPL vs. DPL vs. RPL">
<meta property="og:url" content="https://openwares.net/2019/02/09/cpl-vs-dpl-vs-rpl/index.html">
<meta property="og:site_name" content="openwares.net">
<meta property="og:description" content="CPL vs. DPL vs. RPLTo make this simpler, let’s first just consider CPL and DPL:    The CPL is your current privilege level.   The DPL is the privilege level of a segment. It defines the minimum1 priv">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-02-09T07:02:00.000Z">
<meta property="article:modified_time" content="2020-12-04T12:01:09.098Z">
<meta property="article:author" content="changuoqiang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://openwares.net/2019/02/09/cpl-vs-dpl-vs-rpl/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>CPL vs. DPL vs. RPL | openwares.net</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">openwares.net</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Freedom & Beauty</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CPL-vs-DPL-vs-RPL"><span class="nav-number">1.</span> <span class="nav-text">CPL vs. DPL vs. RPL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-motivation-behind-RPL"><span class="nav-number">2.</span> <span class="nav-text">The motivation behind RPL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Then-and-now"><span class="nav-number">3.</span> <span class="nav-text">Then and now</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RPL-Was-it-ever-necessary"><span class="nav-number">4.</span> <span class="nav-text">RPL: Was it ever necessary?</span></a></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">changuoqiang</p>
  <div class="site-description" itemprop="description">open source and free matters</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">983</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2019/02/09/cpl-vs-dpl-vs-rpl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="changuoqiang">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CPL vs. DPL vs. RPL
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-02-09 15:02:00" itemprop="dateCreated datePublished" datetime="2019-02-09T15:02:00+08:00">2019-02-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GNU-Linux/" itemprop="url" rel="index"><span itemprop="name">GNU/Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <a id="more"></a>
<h1 id="CPL-vs-DPL-vs-RPL"><a href="#CPL-vs-DPL-vs-RPL" class="headerlink" title="CPL vs. DPL vs. RPL"></a>CPL vs. DPL vs. RPL</h1><p>To make this simpler, let’s first just consider CPL and DPL:</p>
<ul>
<li>  The CPL is your current privilege level.</li>
<li>  The DPL is the privilege level of a segment. It defines the minimum1 privilege level required to access the segment.</li>
<li>  Privilege levels range from 0-3; lower numbers are <em>more</em> privileged</li>
<li>  So: To access a segment, CPL must be less than or equal to the DPL of the segment</li>
</ul>
<p>RPL is a privilege level associated with a <em>segment selector</em>. A segment selector is just a 16-bit value that references a segment. Every memory access (implicitly2 or otherwise) uses a segment selector as part of the access.</p>
<p>When accessing a segment, there are actually two checks that must be performed. Access to the segment is only allowed if <em>both</em> of the following are true:</p>
<ul>
<li>  CPL &lt;= DPL</li>
<li>  RPL &lt;= DPL</li>
</ul>
<p>So even if CPL is sufficiently privileged to access a segment, the access will still be denied if the segment selector that references that segment is not sufficiently privileged.</p>
<h1 id="The-motivation-behind-RPL"><a href="#The-motivation-behind-RPL" class="headerlink" title="The motivation behind RPL"></a>The motivation behind RPL</h1><p><em>What’s the purpose of this?</em> Well, the reasoning is a bit dated now, but the Intel documentation offers a scenario that goes something like this:</p>
<ul>
<li>  Suppose the operating system provides a system call that accepts a logical address (segment selector + offset) from the caller and writes to that address</li>
<li>  Normal applications run with a CPL of 3; system calls run with a CPL of 0</li>
<li>  Let’s say some segment (we’ll call it X) has a DPL of 0</li>
</ul>
<p>An application would ordinarily not be able to access the memory in segment X (because CPL &gt; DPL). But depending on how the system call was implemented, an application might be able to invoke the system call with a parameter of an address within segment X. Then, because the system call is privileged, it would be able to write to segment X on behalf of the application. This could introduce a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Privilege_escalation">privilege escalation vulnerability</a> into the operating system.</p>
<p>To mitigate this, the official recommendation is that when a privileged routine accepts a segment selector provided by unprivileged code, it should first set the RPL of the segment selector to match that of the unprivileged code3. This way, the operating system would not be able to make any accesses to that segment that the unprivileged caller would not already be able to make. This helps enforce the boundary between the operating system and applications.</p>
<h1 id="Then-and-now"><a href="#Then-and-now" class="headerlink" title="Then and now"></a>Then and now</h1><p>Segment protection was introduced with the 286, before paging existed in the x86 family of processors. Back then, segmentation was the only way to restrict access to kernel memory from a user-mode context. RPL provided a convenient way to enforce this restriction when passing pointers across different privilege levels.</p>
<p>Modern operating systems use paging to restrict access to memory, which removes the need for segmentation. Since we don’t need segmentation, we can use a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Flat_memory_model">flat memory model</a>, which means segment registers <code>CS</code>, <code>DS</code>, <code>SS</code>, and <code>ES</code> all have a base of zero and extend through the entire address space. In fact, in 64-bit “long mode”, a flat memory model is <em>enforced</em>, regardless of the contents of those four segment registers. Segments are still used sometimes (for example, Windows uses <code>FS</code> and <code>GS</code> to point to the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">Thread Information Block</a> and 0x23 and 0x33 to <a target="_blank" rel="noopener" href="http://www.malwaretech.com/2014/02/the-0x33-segment-selector-heavens-gate.html">switch between 32- and 64-bit code</a>, and Linux is similar), but you just don’t go passing segments around anymore. So RPL is mostly an unused leftover from older times.</p>
<h1 id="RPL-Was-it-ever-necessary"><a href="#RPL-Was-it-ever-necessary" class="headerlink" title="RPL: Was it ever necessary?"></a>RPL: Was it ever <em>necessary</em>?</h1><p>You asked why it was a necessity to have both DPL and RPL. Even in the context of the 286, it wasn’t actually a <em>necessity</em> to have RPL. Considering the above scenario, a privileged procedure could always just retrieve the DPL of the provided segment via the LAR instruction, compare this to the privilege of the caller, and preemptively bail out if the caller’s privilege is insufficient to access the segment. However, setting the RPL, in my opinion, is a more elegant and simpler way of managing segment accesses across different privilege levels.</p>
<p>To learn more about privilege levels, check out Volume 3 of <a target="_blank" rel="noopener" href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">Intel’s software developer manuals</a>, particularly the sections titled “Privilege Levels” and “Checking Caller Access Privileges”.</p>
<p>1 Technically, the DPL can have different meanings depending on what type of segment or gate is being accessed. For the sake of simplicity, everything I describe applies to <em>data segments</em> specifically. Check the Intel docs for more information<br>2 For example, the instruction pointer implicitly uses the segment selector stored in CS when fetching instructions; most types of data accesses implicitly use the segment selector stored in DS, etc.<br>3 See the ARPL instruction (16-bit/32-bit protected mode only)</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/02/08/macosx-mplayer-osd-issue/" rel="prev" title="MacOSX mplayer OSD issue">
                  <i class="fa fa-chevron-left"></i> MacOSX mplayer OSD issue
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/02/16/linux-amd64-memory-mapping/" rel="next" title="linux amd64 memory mapping">
                  linux amd64 memory mapping <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">changuoqiang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  

<script src="/js/local-search.js"></script>






  






</body>
</html>
