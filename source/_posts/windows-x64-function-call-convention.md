---
title: windows x64函数调用约定(function call convention)
tags: []
id: '674'
categories:
  - - Misc
date: 2009-12-28 21:47:31
---

　　借PC处理器架构由x86向x64过渡之机，MS清理了windows x64平台上的函数调用约定，由原来的数种包括stdcall,thiscall,fastcall,cdecl,pascal等，统一为一种新的fastcall调用方式。这种调用方式得益于x64平台寄存器数量的增加。
　　
　　windows x64平台fastcall调用约定的主要特性如下：

*   前四个整型或指针类型参数由RCX,RDX,R8,R9依次传递，前四个浮点类型参数由XMM0,XMM1,XMM2,XMM3依次传递。
*   调用函数为前四个参数在调用栈上保留相应的空间，称作shadow space或spill slot。即使被调用方没有或小于4个参数，调用函数仍然保留那么多的栈空间，这有助于在某些特殊情况下简化调用约定。
*   除前四个参数以外的任何其他参数通过栈来传递，从右至左依次入栈。
*   由调用函数负责清理调用栈。
*   小于等于64位的整型或指针类型返回值由RAX传递。
*   浮点返回值由XMM0传递。
*   更大的返回值(比如结构体)，由调用方在栈上分配空间，并有RCX持有该空间的指针并传递给被调用函数，因此整型参数使用的寄存器依次右移一格，实际只可以利用3个寄存器，其余参数入栈。函数调用结束后，RAX返回该空间的指针。
*   除RCX,RDX,R8,R9以外，RAX、R10、R11、XMM4 和 XMM5也是易变化的(volatile)寄存器。
*   RBX, RBP, RDI, RSI, R12, R13, R14, and R15寄存器则必须在使用时进行保护。
*   在寄存器中，所有参数都是右对齐的。小于64位的参数并不进行高位零扩展，也就是高位是无法预测的垃圾数据。