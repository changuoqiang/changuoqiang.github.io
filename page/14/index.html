<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"openwares.net","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}};
  </script>
<meta name="description" content="open source and free matters">
<meta property="og:type" content="website">
<meta property="og:title" content="openwares.net">
<meta property="og:url" content="https://openwares.net/page/14/index.html">
<meta property="og:site_name" content="openwares.net">
<meta property="og:description" content="open source and free matters">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="openwares">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://openwares.net/page/14/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<title>openwares.net</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">openwares.net</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Freedom & Beauty</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">openwares</p>
  <div class="site-description" itemprop="description">open source and free matters</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">985</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/30/gcc-remove-unused-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/30/gcc-remove-unused-code/" class="post-title-link" itemprop="url">GCC编译链接时移除未使用的代码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-30 10:45:50" itemprop="dateCreated datePublished" datetime="2018-11-30T10:45:50+08:00">2018-11-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GNU-Linux/" itemprop="url" rel="index"><span itemprop="name">GNU/Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>编译时把数据和函数放到单独的section中，然后链接的时候抛弃掉未使用的section就可以了。</p>
<p>也就是组合使用CFLAGS: <code>-ffunction-sections -fdata-sections</code> 和 LDFLAGS: <code>-Wl,--gc-sections</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cc foo.c -o foo -Os -fdata-sections -ffunction-sections -Wl,--gc-sections -s</span><br></pre></td></tr></table></figure>

<p>-s 选项剥离掉调试信息，可以进一步减小目标文件的尺寸。</p>
<p>References:<br>[1]<a target="_blank" rel="noopener" href="https://embeddedfreak.wordpress.com/2009/02/10/removing-unused-functionsdead-codes-with-gccgnu-ld/">Removing Unused Functions/Dead Codes with GCC/GNU-ld</a><br>[2]<a target="_blank" rel="noopener" href="http://gcc.gnu.org/ml/gcc-help/2003-08/msg00128.html">Re: Removing unused functions/dead code</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/29/webassembly-cwrap-bigstring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/29/webassembly-cwrap-bigstring/" class="post-title-link" itemprop="url">WebAssembly cwrap无法传递大字符串问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-29 22:57:23" itemprop="dateCreated datePublished" datetime="2018-11-29T22:57:23+08:00">2018-11-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>当用很大的字符串调用cwrap包装的wasm函数时，出现如下错误：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stack overflow! Attempted to allocate <span class="number">8588685</span> bytes on the stack, but stack has only <span class="number">5242877</span> bytes available!</span><br></pre></td></tr></table></figure>

<p>这是数据太大，把栈撑爆了。cwrap使用stack来传递临时数据，只能拷贝数据，不支持引用传递，不支持自动扩展，并且，stack上的数据是临时的，被调用的代码如果保存通过stack传递进来的指针以备后用，有可能会引用到无效的数据，这是不安全的。<br>所以这样来传递大量数据是不妥当的，应该使用WebAssembly模块的heap来传递这样的大字符串。</p>
<p>官方文档是这样说的：<br>cwrap uses the C stack for temporary values. If you pass a string then it is only “alive” until the call is complete. If the code being called saves the pointer to be used later, it may point to invalid data. If you need a string to live forever, you can create it, for example, using _malloc and stringToUTF8(). However, you must later delete it manually!</p>
<p>可以使用Module._malloc()和Module.stringToUTF8()函数通过heap来传递大量数据：<br>[cpp]<br>const bufferSize = Module.lengthBytesUTF8(veryLargeString) + 1;<br>const bufferPtr = Module._malloc(bufferSize);<br>Module.stringToUTF8(veryLargeString, bufferPtr, bufferSize);<br>const sample = Module.cwrap(‘sample’, null, [‘number’]); // not ‘string’, pointer is a number<br>sample(bufferPtr);<br>Module._free(bufferPtr);<br>[/cpp]</p>
<p>要注意Module.lengthBytesUTF8给出的长度并不包括空终结符，所以缓冲区大小要再加1。被调用的函数不再使用string类型的参数，而改用number类型，因为指针就是一个number。分配的缓冲区使用完之后记得要free掉，不然会造成内存泄露。</p>
<p>为了确保heap能自动增长，build模块时应该添加-s ALLOW_MEMORY_GROWTH=1参数，就不用害怕传递大型参数了。</p>
<p>还有一个更简洁的包装方法allocateUTF8可用，直接传递给它数据，它就可以将数据拷贝到堆上，并返回在heap上分配的空间地址，这样用：<br>[cpp]<br>const bufferPtr = allocateUTF8(veryLargeString);<br>const sample = Module.cwrap(‘sample’, null, [‘number’]); // not ‘string’, pointer is a number<br>sample(bufferPtr);<br>Module._free(bufferPtr);<br>[/cpp]</p>
<p>allocateUTF8的源代码：<br>[javascript]<br>// Allocate heap space for a JS string, and write it there.<br>// It is the responsibility of the caller to free() that memory.<br>function allocateUTF8(str) {<br> var size = lengthBytesUTF8(str) + 1;<br> var ret = _malloc(size);<br> if (ret) stringToUTF8Array(str, HEAP8, ret, size);<br> return ret;<br>}<br>[/javascript]</p>
<p>wasm模块可以从emscripten HEAP上返回字符串，只要给javascript传回一个空终结UTF8编码的字符串指针就可以了：</p>
<p>[javascript]<br>// Given a pointer ‘ptr’ to a null-terminated UTF8-encoded string in the emscripten HEAP, returns<br>// a copy of that string as a Javascript String object.</p>
<p>function UTF8ToString(ptr) {<br> return UTF8ArrayToString(HEAPU8,ptr);<br>}<br>[/javascript]</p>
<p><strong>最后</strong>：</p>
<p>其实stack和heap都分配自WebAssembly.memory对象，这是一个ArrayBuffer对象，可以使用不同的视图来存取。stack和heap的区别是使用和管理内存的方式不同。<br>调用instance.exports._malloc时是调用的是C/C++标准库的malloc函数，而emscripten实现的malloc函数正是在WebAssembly.memory上动态分配内存。</p>
<p>References:<br>[1]<a target="_blank" rel="noopener" href="https://github.com/kripken/emscripten/issues/6860">Stack overflow error when large string passed</a><br>[2]<a target="_blank" rel="noopener" href="https://github.com/kripken/emscripten/issues/4344">Automatically growing the stack</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/28/twentyseventeen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/28/twentyseventeen/" class="post-title-link" itemprop="url">twentyseventeen</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-28 14:57:54" itemprop="dateCreated datePublished" datetime="2018-11-28T14:57:54+08:00">2018-11-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>.wrap {<br>/* margin-left: auto; <em>/<br>/</em> margin-right: auto; <em>/<br>max-width: 100%;<br>/</em> padding-left: 2em; <em>/<br>/</em> padding-right: 2em; */<br>}</p>
<p>@media screen and (min-width: 48em) {<br>.wrap {<br>max-width: 100%;<br>/* padding-left: 3em; <em>/<br>/</em> padding-right: 3em; */<br>}<br>}</p>
<p>.page.page-one-column:not(.twentyseventeen-front-page) #primary {<br>/<em>margin-left: auto;</em>/<br>/<em>margin-right: auto;</em>/<br>max-width: 100%;<br>}</p>
<p>@media screen and (min-width: 30em) {<br>.page-one-column .panel-content .wrap<br>{<br>max-width: 100%;<br>}<br>}</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/28/flatpak-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/28/flatpak-intro/" class="post-title-link" itemprop="url">flatpak简单介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-28 14:11:49" itemprop="dateCreated datePublished" datetime="2018-11-28T14:11:49+08:00">2018-11-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GNU-Linux/" itemprop="url" rel="index"><span itemprop="name">GNU/Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>GIMP改用flatpak打包，flatpak以前叫xdg-app，现在flatpak是指flat package吗?</p>
<p>flatpak是一种致力于减少依赖的通用应用打包格式，与之竞争的还有snap和AppImage</p>
<p><strong>安装</strong></p>
<p>flatpak已经进入debian当前的testing buster源和sid源， debian stretch可以从官方的backports源<code>deb http://ftp.tw.debian.org/debian stretch-backports main contrib non-free</code>安装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt install flatpak</span><br></pre></td></tr></table></figure>

<p>添加flatpak官方源</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo flatpak remote-add --<span class="keyword">if</span>-not-exists flathub https:<span class="comment">//flathub.org/repo/flathub.flatpakrepo</span></span><br></pre></td></tr></table></figure>

<p>因为flatpak本身就是一种app打包格式，官方应该提供一个自举安装的shell脚本才显得更专业:)</p>
<p><strong>安装gimp</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flatpak install https:<span class="comment">//flathub.org/repo/appstream/org.gimp.GIMP.flatpakref</span></span><br></pre></td></tr></table></figure>

<p>可以使用桌面图标运行，或者使用以下命令：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flatpak run org.gimp.GIMP<span class="comment">//stable</span></span><br></pre></td></tr></table></figure>

<p><strong>flatpak文件系统布局</strong></p>
<p>flatpak支持系统范围安装和用户安装，系统安装在/var/lib/flatpak,<br>安装的app系统配置在/var/lib/flatpak/app，其他子目录为flatpak本身系统范围的配置<br>安装的app的当前用户配置在$HOME/.var/app，flatpak本身的当前用户配置在$HOME/.local/share/flatpak</p>
<p>References:<br>[1]<a target="_blank" rel="noopener" href="https://flatpak.org/">Flatpak</a><br>[2]<a target="_blank" rel="noopener" href="https://github.com/flatpak/flatpak/wiki/Filesystem">Flatpak filesystem layout</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/27/cwrap-call-webassembly-method/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/27/cwrap-call-webassembly-method/" class="post-title-link" itemprop="url">使用cwrap调用WebAssembly模块方法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-27 22:26:29" itemprop="dateCreated datePublished" datetime="2018-11-27T22:26:29+08:00">2018-11-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>Emscripten提供了很多库的webassembly实现，甚至为了文件系统存取还提供了虚拟文件系统，这可以让很多C/C++代码做很少的修改就可以移植到web上来运行。</p>
<p>目前来讲js直接与wasm代码交互还不是那么方便，通过Emscripten提供的js glue代码可以使这个过程更简单一点。</p>
<p>胶水代码导出了一个名字空间Module，其中有两个方法ccall和cwarp作为桥接原生代码的桥梁，ccall适合一次性的调用C/C++函数，而cwrap则返回一个函数适配器，适合多次反复调用C/C++代码。</p>
<p>使用如下命令编译C/C++代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ emcc area.c triangle.c -Os -s WASM=<span class="number">1</span> -o area.js </span><br><span class="line">-s <span class="string">&quot;EXPORTED_FUNCTIONS=\[&#x27;_getArea&#x27;\]&quot;</span> </span><br><span class="line">-s EXTRA_EXPORTED_RUNTIME_METHODS=<span class="string">&#x27;\[&quot;ccall&quot;, &quot;cwrap&quot;\]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>-Oz比-Os可以做更进一步的编译器优化，生成的代码更小。</p>
<p>除了要导出你自己的函数之外，还要导出这两个辅助方法ccall和cwrap<br>编译完后会生成area.wasm和胶水代码area.js</p>
<p>将area.js导入到html中，然后就可以写下面的代码来获取到导出的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> area = Module.cwrap(<span class="string">&#x27;getArea&#x27;</span>, <span class="string">&#x27;number&#x27;</span>, \[<span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;array&#x27;</span>\]);</span><br></pre></td></tr></table></figure>

<p>cwrap的第一个参数为导出的函数名，第二个参数为函数返回值，第三个参数为函数的参数。<br>目前数据类型支持的很少，有number, array, string, boolean, null等，而且array只接受Uint8Array类型。<br>对于C/C++的指针类型可以用array来传递数据。</p>
<p>对于ccall来讲，则除了cwrap的参数之外，还要将函数的实参传递进去，完成真正的函数调用，然后返回函数值。</p>
<p>References:<br>[1]<a target="_blank" rel="noopener" href="http://kripken.github.io/emscripten-site/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html">Interacting with code</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/27/beautiful-font-for-terminal-and-dev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/27/beautiful-font-for-terminal-and-dev/" class="post-title-link" itemprop="url">一款漂亮开放自由的编程、终端字体</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-27 20:33:38" itemprop="dateCreated datePublished" datetime="2018-11-27T20:33:38+08:00">2018-11-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GNU-Linux/" itemprop="url" rel="index"><span itemprop="name">GNU/Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>偶然发现一款漂亮的编程字体inconsolata，而且是自由、开放字体，值得推荐</p>
<p>debian官方源里就有:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install fonts-inconsolata</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/27/webassembly-standalone%E6%A8%A1%E5%9D%97%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/27/webassembly-standalone%E6%A8%A1%E5%9D%97%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">WebAssembly standalone模块示例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-27 14:50:17" itemprop="dateCreated datePublished" datetime="2018-11-27T14:50:17+08:00">2018-11-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>WebAssembly还是个很新鲜的玩意儿，ABI都还没稳定。<br>通常emscripten/emcc会产生厚厚的胶水代码来连接Javascript和wasm模块，通过import/export，Javascript和原生代码可以相互访问、调用，<br>除了简单数据类型，还可以通过memory和table来模拟指针、函数指针运算。<br>当前，emscripten/emcc已经支持生成standalone单独的wasm模块，无需胶水代码就可以简单使用标准的JS来访问wasm数据和代码，下面是一个简单的栗子：</p>
<p><strong>C代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">double buf\[<span class="number">1024</span>\];</span><br><span class="line"></span><br><span class="line">double* <span class="function"><span class="title">getOffset</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double <span class="function"><span class="title">add</span>(<span class="params">int count</span>)</span>&#123;</span><br><span class="line"> double sum = <span class="number">0.0</span>;</span><br><span class="line"> <span class="keyword">for</span>(int i=<span class="number">0</span>; i&lt;count; i++)&#123;</span><br><span class="line"> sum += buf\[i\];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>add函数计算buf缓冲区中前count个浮点数之和，注意这里整个C代码没有任何其他库的依赖。</p>
<p><strong>编译成wasm</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ emcc add.c -Os -s WASM=<span class="number">1</span> -s <span class="string">&quot;EXPORTED_FUNCTIONS=\[&#x27;_add&#x27;, &#x27;_getOffset&#x27;\]&quot;</span> -s SIDE_MODULE=<span class="number">1</span> -o add.wasm</span><br></pre></td></tr></table></figure>

<p>-Os 编译优化选项会将所有用不到的代码去除掉，也不会包括任何标准库<br>-s WASM=1 指示生成wasm文件<br>-s “EXPORTED_FUNCTIONS=[‘_add’, ‘_getOffset’]“ 指示导出add和getOffset这个两个函数，导出标识符要用C的方式，C++语言的时候要注意名字碾压，导出的函数需要使用extern “C”修饰<br>-s SIDE_MODULE=1 指示生成wasm动态库</p>
<p>生成的add.wasm可以使用<a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt</a>(The WebAssembly Binary Toolkit)工具集中的命令wasm2wat转换为WebAssembly的wat/wast文本S-Express格式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">$ wasm2wat add.wasm</span><br><span class="line">(<span class="built_in">module</span></span><br><span class="line"> (type (;<span class="number">0</span>;) (func (result i32)))</span><br><span class="line"> (type (;<span class="number">1</span>;) (func (param i32) (result f64)))</span><br><span class="line"> (type (;<span class="number">2</span>;) (func))</span><br><span class="line"> (<span class="keyword">import</span> <span class="string">&quot;env&quot;</span> <span class="string">&quot;__memory_base&quot;</span> (<span class="built_in">global</span> (;<span class="number">0</span>;) i32))</span><br><span class="line"> (<span class="keyword">import</span> <span class="string">&quot;env&quot;</span> <span class="string">&quot;memory&quot;</span> (memory (;<span class="number">0</span>;) <span class="number">256</span>))</span><br><span class="line"> (func (;<span class="number">0</span>;) (type <span class="number">0</span>) (result i32)</span><br><span class="line"> get_global <span class="number">0</span>)</span><br><span class="line"> (func (;<span class="number">1</span>;) (type <span class="number">1</span>) (param i32) (result f64)</span><br><span class="line"> (local i32 f64)</span><br><span class="line"> get_local <span class="number">0</span></span><br><span class="line"> i32.const <span class="number">0</span></span><br><span class="line"> i32.gt_s</span><br><span class="line"> <span class="keyword">if</span> ;; label = @<span class="number">1</span></span><br><span class="line"> loop ;; label = @<span class="number">2</span></span><br><span class="line"> get_local <span class="number">2</span></span><br><span class="line"> get_global <span class="number">0</span></span><br><span class="line"> get_local <span class="number">1</span></span><br><span class="line"> i32.const <span class="number">3</span></span><br><span class="line"> i32.shl</span><br><span class="line"> i32.add</span><br><span class="line"> f64.load</span><br><span class="line"> f64.add</span><br><span class="line"> set_local <span class="number">2</span></span><br><span class="line"> get_local <span class="number">1</span></span><br><span class="line"> i32.const <span class="number">1</span></span><br><span class="line"> i32.add</span><br><span class="line"> tee_local <span class="number">1</span></span><br><span class="line"> get_local <span class="number">0</span></span><br><span class="line"> i32.ne</span><br><span class="line"> br_if <span class="number">0</span> (;@<span class="number">2</span>;)</span><br><span class="line"> end</span><br><span class="line"> end</span><br><span class="line"> get_local <span class="number">2</span>)</span><br><span class="line"> (func (;<span class="number">2</span>;) (type <span class="number">2</span>)</span><br><span class="line"> nop)</span><br><span class="line"> (func (;<span class="number">3</span>;) (type <span class="number">2</span>)</span><br><span class="line"> get_global <span class="number">0</span></span><br><span class="line"> i32.const -<span class="number">8192</span></span><br><span class="line"> i32.sub</span><br><span class="line"> set_global <span class="number">1</span></span><br><span class="line"> get_global <span class="number">1</span></span><br><span class="line"> i32.const <span class="number">5242880</span></span><br><span class="line"> i32.add</span><br><span class="line"> set_global <span class="number">2</span>)</span><br><span class="line"> (<span class="built_in">global</span> (;<span class="number">1</span>;) (mut i32) (i32.const <span class="number">0</span>))</span><br><span class="line"> (<span class="built_in">global</span> (;<span class="number">2</span>;) (mut i32) (i32.const <span class="number">0</span>))</span><br><span class="line"> (<span class="built_in">global</span> (;<span class="number">3</span>;) i32 (i32.const <span class="number">0</span>))</span><br><span class="line"> (<span class="keyword">export</span> <span class="string">&quot;__post_instantiate&quot;</span> (func <span class="number">3</span>))</span><br><span class="line"> (<span class="keyword">export</span> <span class="string">&quot;_add&quot;</span> (func <span class="number">1</span>))</span><br><span class="line"> (<span class="keyword">export</span> <span class="string">&quot;_getOffset&quot;</span> (func <span class="number">0</span>))</span><br><span class="line"> (<span class="keyword">export</span> <span class="string">&quot;runPostSets&quot;</span> (func <span class="number">2</span>))</span><br><span class="line"> (<span class="keyword">export</span> <span class="string">&quot;_buf&quot;</span> (<span class="built_in">global</span> <span class="number">3</span>)))</span><br></pre></td></tr></table></figure>

<p>可以看到add.wasm的import和export的各种东西global、func、memory，如果使用了函数指针还会有table<br>如果没用到memory，可以用wasm2wat将其转为wat/wast文本格式，将import memory相关去掉，<br>然后使用wat2wasm再编译回wasm格式就无需导入任何东西了。</p>
<p><strong>调用wasm</strong></p>
<p>写一个简单的页面来调用wasm代码：<br>[html]<br><!doctype html></p>
<html lang="en-us">
 <head>
 <meta charset="utf-8">
 <script>
 // Check for wasm support.
 if (!('WebAssembly' in window)) {
 alert('you need a browser with wasm support enabled :(');
 }
 // Loads a WebAssembly dynamic library, returns a promise.
 // imports is an optional imports object
 var importObj = {
 'env': {'__memory_base': 0, 
 'memory': new WebAssembly.Memory({initial: 256})
 // if used function pointer
 '__table_base': 0,
 'table': new WebAssembly.Table({ initial: 0, element: 'anyfunc' })
 }
 }
 WebAssembly.instantiateStreaming(fetch('add.wasm'), importObj)
 .then(obj => {
 var button = document.getElementById('run');
 button.value = 'Call a method in the WebAssembly module';
 var exports= obj.instance.exports;
 button.addEventListener('click', function() {
 var offset = exports._getOffset();
 var mem = new Float64Array(importObj.env.memory.buffer, offset , 2);
 //var mem = new Float64Array(importObj.env.memory.buffer, exports._buf , 2);
 mem\[0\] = 1.2;
 mem\[1\] = 2.4;
 alert('1.2 + 2.4 is ' + exports._add(2));
 }, false);
 });
 </script>
 </head>
 <body>
 <input type="button" id="run" value="(waiting for WebAssembly)"/>
 </body>
</html>
\[/html\]

<p>其实获取C代码缓冲区起始地址的getOffset并没有必要，因为wasm模块直接导出了缓冲器的标识符_buf，其实就是缓冲区的首地址<br>除了基本类型，JS和原生代码通过memory的buffer来交换大块的数据。</p>
<p><strong>访问</strong></p>
<p>需要起一个web server</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m http.server <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>然后访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8081/add.html%EF%BC%8C%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0JS%E8%B0%83%E7%94%A8WASM%E4%B8%AD%E7%9A%84routine%E7%84%B6%E5%90%8E%E8%BF%94%E5%9B%9E%E4%BA%86%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C%E3%80%82">http://127.0.0.1:8081/add.html，点击按钮可以看到JS调用WASM中的routine然后返回了计算结果。</a></p>
<p><strong>最后</strong></p>
<p>如果WASM模块依赖于其他库代码，目前还无法生成standalone模块，需要生成胶水js代码来访问。</p>
<p>另外，tableBase和memoryBase已经更名为__table_base和__memory_base</p>
<p>References:<br>[1]<a target="_blank" rel="noopener" href="https://github.com/kripken/emscripten/wiki/WebAssembly-Standalone">WebAssembly Standalone</a><br>[2]<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/41653792/disable-linking-libc-in-emscripten/41871785">Disable linking libc in emscripten</a><br>[3]<a target="_blank" rel="noopener" href="https://github.com/kripken/emscripten/pull/7467/commits/74ec83aec8227c55c1431411ceed15e3585ddff5">Rename tableBase/memoryBase to __table_base/__memory_base</a><br>[4]<a target="_blank" rel="noopener" href="https://github.com/WebAssembly/tool-conventions/blob/master/DynamicLinking.md">WebAssembly Dynamic Linking</a><br>[5]<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46748572/how-to-access-webassembly-linear-memory-from-c-c">How to access WebAssembly linear memory from C/C++</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/26/python3-http-server-wasm-mime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/26/python3-http-server-wasm-mime/" class="post-title-link" itemprop="url">python3 http.server中wasm的mime类型配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-26 23:25:49" itemprop="dateCreated datePublished" datetime="2018-11-26T23:25:49+08:00">2018-11-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>使用WebAssembly.instantiateStreaming(fetch(‘add.wasm’), imports)以流方式获取wasmw文件时,chrome会抱怨:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Uncaught (<span class="keyword">in</span> promise) <span class="built_in">TypeError</span>: Failed to execute <span class="string">&#x27;compile&#x27;</span> on <span class="string">&#x27;WebAssembly&#x27;</span>: </span><br><span class="line">Incorrect response MIME type. Expected <span class="string">&#x27;application/wasm&#x27;</span>.</span><br></pre></td></tr></table></figure>

<p>查看server.py发现使用了mimetypes模块来管理mime types，调用mimetypes.init()方法时，会使用mimetypes.knownfiles文件中记载的mime types</p>
<p>查看knowfiles路径：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">import</span> mimetypes</span><br><span class="line">&gt;&gt;&gt; mimetypes.knownfiles</span><br><span class="line">\[<span class="string">&#x27;/etc/mime.types&#x27;</span>, <span class="string">&#x27;/etc/httpd/mime.types&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;/etc/httpd/conf/mime.types&#x27;</span>, <span class="string">&#x27;/etc/apache/mime.types&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;/etc/apache2/mime.types&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;/usr/local/etc/httpd/conf/mime.types&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;/usr/local/lib/netscape/mime.types&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;/usr/local/etc/httpd/conf/mime.types&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;/usr/local/etc/mime.types&#x27;</span>\]</span><br></pre></td></tr></table></figure>

<p>MacOS上这些文件基本都不存在，添加文件/usr/local/etc/mime.types，其内容添加如下行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application/wasm wasm</span><br></pre></td></tr></table></figure>

<p>重新启动http.server就好了，注意清除浏览器缓存再试。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/26/clang-set-default-version/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/26/clang-set-default-version/" class="post-title-link" itemprop="url">多clang环境设置默认clang版本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-26 12:38:55" itemprop="dateCreated datePublished" datetime="2018-11-26T12:38:55+08:00">2018-11-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>debian当前源内的clang版本为3.8，backport源里的版本为6.0</p>
<p>设置默认版本为6.0:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-alternatives --install \\</span><br><span class="line">/usr/bin/clang++ clang++ <span class="regexp">/usr/</span>lib/llvm-<span class="number">6.0</span>/bin/clang++ <span class="number">100</span></span><br><span class="line">$ sudo update-alternatives --install \\</span><br><span class="line"> /usr/bin/clang clang /usr/lib/llvm-<span class="number">6.0</span>/bin/clang <span class="number">100</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://openwares.net/2018/11/25/linode-latest-kernel-docker-service-faile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="openwares">
      <meta itemprop="description" content="open source and free matters">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="openwares.net">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/11/25/linode-latest-kernel-docker-service-faile/" class="post-title-link" itemprop="url">linode最新内核docker服务无法启动</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-11-25 12:20:35" itemprop="dateCreated datePublished" datetime="2018-11-25T12:20:35+08:00">2018-11-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-12-04 20:01:09" itemprop="dateModified" datetime="2020-12-04T20:01:09+08:00">2020-12-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <a id="more"></a>
<p>升级完linode发现docker服务无法启动了，containerd服务报找不到overlay模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">modprobe: FATAL: Module overlay not found</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>linode内核早就启用overlay模块了，这是docker bug导致的。</p>
<p>执行以下命令来解决此问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ su -</span><br><span class="line">$ mkdir -p /etc/systemd/system/containerd.service.d/</span><br><span class="line"></span><br><span class="line">$ cat &lt;&lt; EOF &gt; <span class="regexp">/etc/</span>systemd/system/containerd.service.d/override.conf</span><br><span class="line">\[Service\]</span><br><span class="line">ExecStartPre=</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">$ systemctl start docker</span><br></pre></td></tr></table></figure>

<p>References:<br>[1]<a target="_blank" rel="noopener" href="https://www.linode.com/community/questions/17114/docker-wont-start-using-the-latest-linode-kernel#answer-67343">Docker won’t start using the latest Linode kernel</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/99/">99</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">openwares</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  

<script src="/js/local-search.js"></script>






  






</body>
</html>
